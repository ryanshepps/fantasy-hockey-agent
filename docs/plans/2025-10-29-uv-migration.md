# UV Package Manager Migration Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Migrate the fantasy-hockey-test project from pip to uv package manager for faster installs, reproducible builds, and modern Python tooling.

**Architecture:** Replace pip-based dependency management with uv. Move dependencies from requirements.txt to pyproject.toml [project.dependencies] section. Update GitHub Actions workflows to use the official astral-sh/setup-uv action. Generate and commit uv.lock for reproducible builds.

**Tech Stack:** uv (Astral package manager), GitHub Actions, pyproject.toml (PEP 621)

---

## Task 1: Update pyproject.toml with Dependencies

**Files:**
- Modify: `pyproject.toml` (add [project] and [dependency-groups] sections)

**Step 1: Add project section with dependencies**

Add this content to pyproject.toml before the existing `[tool.ruff]` section:

```toml
[project]
name = "fantasy-hockey-test"
requires-python = ">=3.11"
dependencies = [
    "yfpy>=17.0.0",
    "python-dotenv>=1.0.0",
    "anthropic>=0.39.0",
    "nhl-api-py>=1.0.0",
]

[dependency-groups]
dev = [
    "ruff>=0.8.0",
]

```

**Step 2: Verify pyproject.toml is valid**

Run: `python3 -c "import tomllib; tomllib.load(open('pyproject.toml', 'rb'))"`
Expected: No output (success)

**Step 3: Commit**

```bash
git add pyproject.toml
git commit -m "feat: add dependencies to pyproject.toml for uv"
```

---

## Task 2: Install uv and Generate Lock File

**Files:**
- Create: `uv.lock` (generated by uv)

**Step 1: Install uv locally (if not already installed)**

Run: `curl -LsSf https://astral.sh/uv/install.sh | sh`
Note: Skip if uv is already installed. Verify with `uv --version`

**Step 2: Generate lock file**

Run: `uv lock`
Expected: Creates `uv.lock` file with resolved dependencies

**Step 3: Verify lock file was created**

Run: `ls -lh uv.lock`
Expected: File exists, several KB in size

**Step 4: Test installation from lock file**

Run: `uv sync`
Expected: Installs all dependencies from lock file successfully

**Step 5: Commit lock file**

```bash
git add uv.lock
git commit -m "chore: add uv.lock for reproducible builds"
```

---

## Task 3: Update code-quality.yml Workflow

**Files:**
- Modify: `.github/workflows/code-quality.yml`

**Step 1: Update workflow to use uv**

Replace the existing Python setup and dependency installation steps (lines 15-24) with:

```yaml
      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: uv sync
```

The complete file should look like:

```yaml
name: Code Quality

on:
  pull_request:
    branches: [ main ]

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: uv sync

      - name: Run ruff linting
        run: ruff check .

      - name: Run ruff formatting check
        if: success() || failure() # if the linting fails, we still want to run the formatting check
        run: ruff format --check .
```

**Step 2: Commit workflow changes**

```bash
git add .github/workflows/code-quality.yml
git commit -m "ci: migrate code-quality workflow to uv"
```

---

## Task 4: Update fantasy-hockey-analysis.yml Workflow

**Files:**
- Modify: `.github/workflows/fantasy-hockey-analysis.yml`

**Step 1: Update workflow to use uv**

Replace the existing Python setup and dependency installation steps (lines 29-38) with:

```yaml
      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: uv sync
```

The complete steps section (lines 23-76) should look like:

```yaml
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ssh-key: ${{ secrets.DEPLOY_KEY }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: uv sync

      - name: Create .env file from secrets
        run: |
          cat > .env << EOF
          YAHOO_CLIENT_ID=${{ secrets.YAHOO_CLIENT_ID }}
          YAHOO_CLIENT_SECRET=${{ secrets.YAHOO_CLIENT_SECRET }}
          YAHOO_ACCESS_TOKEN_JSON='${{ secrets.YAHOO_ACCESS_TOKEN_JSON }}'
          LEAGUE_ID=${{ vars.LEAGUE_ID }}
          TEAM_ID=${{ vars.TEAM_ID }}
          GAME_KEY=${{ vars.GAME_KEY }}
          ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
          EMAIL_FROM=${{ secrets.EMAIL_FROM }}
          EMAIL_TO=${{ secrets.EMAIL_TO }}
          EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}
          SMTP_SERVER=${{ vars.SMTP_SERVER }}
          SMTP_USERNAME=${{ secrets.SMTP_USERNAME }}
          SMTP_PORT=${{ vars.SMTP_PORT }}
          EOF

      - name: Run Fantasy Hockey Agent
        run: |
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            python fantasy_hockey_agent.py --dry-run
          else
            python fantasy_hockey_agent.py
          fi

      - name: Commit and push changes
        if: inputs.dry_run != true
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/recommendations_history.json
          git commit -m "chore: add $(date +'%Y-%m-%d') recommendations history" || echo "No changes to commit"
          git add data/player_id_mappings.json
          git commit -m "chore: update player mappings" || echo "No changes to commit"
          git push
```

**Step 2: Commit workflow changes**

```bash
git add .github/workflows/fantasy-hockey-analysis.yml
git commit -m "ci: migrate fantasy-hockey-analysis workflow to uv"
```

---

## Task 5: Remove requirements.txt

**Files:**
- Delete: `requirements.txt`

**Step 1: Verify uv.lock contains all dependencies**

Run: `grep -E "(yfpy|python-dotenv|anthropic|nhl-api-py|ruff)" uv.lock`
Expected: All five dependencies appear in the lock file

**Step 2: Remove requirements.txt**

Run: `rm requirements.txt`

**Step 3: Verify no references remain**

Run: `grep -r "requirements.txt" .github/ README.md 2>/dev/null || echo "No references found"`
Expected: "No references found" (workflows already updated)

**Step 4: Commit deletion**

```bash
git add requirements.txt
git commit -m "chore: remove requirements.txt (replaced by pyproject.toml)"
```

---

## Task 6: Verification

**Files:**
- None (testing only)

**Step 1: Verify local environment**

Run: `uv sync && python3 -c "import yfpy, anthropic, dotenv; print('All imports successful')"`
Expected: "All imports successful"

**Step 2: Check ruff is available**

Run: `ruff --version`
Expected: Outputs ruff version (e.g., "ruff 0.8.x")

**Step 3: Run ruff check**

Run: `ruff check .`
Expected: No errors (existing code is already compliant)

**Step 4: Run ruff format check**

Run: `ruff format --check .`
Expected: No files need formatting

**Step 5: Verify git status is clean**

Run: `git status`
Expected: "nothing to commit, working tree clean"

---

## Success Criteria

- ✅ pyproject.toml contains all dependencies
- ✅ uv.lock file exists and is committed
- ✅ Both GitHub Actions workflows use uv
- ✅ requirements.txt is removed
- ✅ Local environment works with `uv sync`
- ✅ Ruff linting and formatting pass
- ✅ All changes committed with clear messages

## Post-Migration Notes

**For maintainers:**

**Adding dependencies:**
```bash
uv add <package-name>              # Runtime dependency
uv add --dev <package-name>        # Dev dependency
```

**Removing dependencies:**
```bash
uv remove <package-name>
```

**Updating dependencies:**
```bash
uv lock --upgrade                  # Update all dependencies
uv lock --upgrade-package <name>   # Update specific package
```

**Installing dependencies:**
```bash
uv sync                            # Install from lock file
```

**CI/CD:**
- Both workflows now use `astral-sh/setup-uv@v4`
- Dependencies install from `uv.lock` for reproducibility
- Significantly faster than pip-based installs
